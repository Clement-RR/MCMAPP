<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Input_CA</title>
    <script>
        const previous_CA_columns = {{ previous_CA_columns | tojson }};
        // 在页面加载完成后运行此函数
        window.onload = function() {
            createDropdowns();
            loadChangeAttributeData();
        };

        // 此函数负责创建所有的下拉菜单
        function createDropdowns() {
            const dropdownPlaces = document.querySelectorAll('.dropdown-container'); // 选择所有需要下拉菜单的容器

            // 对每个容器进行操作
            dropdownPlaces.forEach(function(container) {
                const select = document.createElement('select'); // 创建select元素
                select.id = container.id ; // 为select元素创建一个基于容器id的唯一id


                // 添加选项1到9
                for (let i = 0; i <= 9; i++) {
                    const option = document.createElement('option'); // 创建option元素
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option); // 将option添加到select中
                }

                if (!previous_CA_columns.includes(container.id)) {
                    select.disabled = true; // 禁用select元素
                }
                container.prepend(select); // 将select添加到当前容器中
            });
        }

        function loadChangeAttributeData() {
            fetch('/get_change_attribute_data')
                .then(response => response.json())
                .then(data => {
                    console.log('Data received:', data);
                    if (data.length > 0) {
                        const changeData = data[0];  // 假设只需要第一条记录
                        console.log('Change data to populate:', changeData)
                        document.getElementById('changeName').value = changeData.changeName || '';
                        document.getElementById('changeId').value = changeData.changeId || '';
                        document.getElementById('changeDescription').value = changeData.changeDescription || '';
                        document.getElementById('responsibility').value = changeData.responsibility || '';
                        document.getElementById('timeframe').value = changeData.timeframe || '';
                        document.getElementById('changeCause').value = changeData.changeCause || '';
                        document.getElementById('localization').value = changeData.localization || '';
                        document.getElementById('departments').value = changeData.departments || '';
                        document.getElementById('changeStatus').value = changeData.changeStatus || '';
                        document.getElementById('timeOfOccurrence').value = changeData.timeOfOccurrence || '';
                        document.getElementById('lessonsLearned').value = changeData.lessonsLearned || '';

                        const dropdownPlaces = document.querySelectorAll('.dropdown-container');
                        dropdownPlaces.forEach(container => {
                            const selectElement = container.querySelector('select');
                            if (selectElement) {
                                selectElement.value = changeData[container.id] || '0';
                            }
                        });
                    }else {
                        console.log('No data available to populate form.');  // 调试输出
                    }
                })
                .catch(error => {
                    console.error('Error loading change attribute data:', error);
                });
        }

        function saveData() {
            const data = {
                changeName: document.getElementById('changeName').value.toString(),
                changeId: document.getElementById('changeId').value.toString(),
                changeDescription: document.getElementById('changeDescription').value.toString(),
                responsibility: document.getElementById('responsibility').value.toString(),
                timeframe: document.getElementById('timeframe').value.toString(),
                changeCause: document.getElementById('changeCause').value.toString(),
                localization: document.getElementById('localization').value.toString(),
                departments: document.getElementById('departments').value.toString(),
                changeStatus: document.getElementById('changeStatus').value.toString(),
                timeOfOccurrence: document.getElementById('timeOfOccurrence').value.toString(),
                lessonsLearned: document.getElementById('lessonsLearned').value.toString()
            };

            const allFields = [
            'impactOnInternal', 'impactOnExternal', 'efforts', 'costs', 'availableDataInformation',
            'dependencyLevel', 'changePropagation', 'changeReoccurrence', 'complexity', 'challenges',
            'duration', 'relevance', 'urgency'
            ];

            // 设置默认值为0
            allFields.forEach(field => {
                data[field] = '0';
            });

            const dropdownPlaces = document.querySelectorAll('.dropdown-container');

            dropdownPlaces.forEach(container => {
                const selectElement = container.querySelector('select');
                if (selectElement) {
                    data[container.id] = selectElement.value;
                }
            });


            fetch('/save_change_attribute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Data saved successfully.');
                    setTimeout(() => {
                        location.reload();
                    }, 100); // 0.1秒延迟后刷新页面
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteChange() {
            fetch('/delete_change_attribute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Data deleted successfully.');
                    setTimeout(() => {
                        location.reload();
                    }, 100);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

    </script>

    <style>
        body {
            display: flex;
            flex-direction: row; /* 确保左右面板水平排列 */
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #leftPanel, #rightPanel {
            width: 50%; /* 左右面板各占50%的宽度 */
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #Specification, #Coordination {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 20px;
        }
        #rightPanel {
            justify-content: space-around;
            align-items: flex-start;
            padding: 40px 20px;
        }
        .input-container {
            margin-bottom: 15px;
            text-align: left;
        }
        .dropdown-container {
            width: 100%;
            margin-bottom: 10px;
            text-align: left;
        }
    </style>
</head>

<body>
    <!-- Left panel -->
    <div id="leftPanel">

        <!-- Specification -->
        <div id="Specification">
            <div class="input-container">
                <label for="changeName">Change Name:</label>
                <input type="text" id="changeName" name="changeName">
            </div>
            <div class="input-container">
                <label for="changeId">Change ID:</label>
                <input type="text" id="changeId" name="changeId">
            </div>
            <div class="input-container">
                <label for="changeDescription">Change description:</label>
                <input type="text" id="changeDescription" name="changeDescription">
            </div>
            <div class="input-container">
                <label for="responsibility">Responsibility:</label>
                <input type="text" id="responsibility" name="responsibility">
            </div>
            <div class="input-container">
                <label for="timeframe">Timeframe:</label>
                <input type="datetime-local" id="timeframe" name="timeframe">
            </div>
            <div class="input-container">
                <label for="changeCause">Change cause:</label>
                <input type="text" id="changeCause" name="changeCause">
            </div>
            <div class="input-container">
                <label for="localization">Localization:</label>
                <input type="text" id="localization" name="localization">
            </div>
            <div class="input-container">
                <label for="departments">Departments:</label>
                <input type="text" id="departments" name="departments">
            </div>
        </div>

        <!-- Coordination -->
        <div id="Coordination">
            <div class="input-container">
                <label for="changeStatus">Change Status:</label>
                <input type="text" id="changeStatus" name="changeStatus">
            </div>
            <div class="input-container">
                <label for="timeOfOccurrence">Time of occurrence:</label>
                <input type="datetime-local" id="timeOfOccurrence" name="timeOfOccurrence">
            </div>
            <div class="input-container">
                <label for="lessonsLearned">Lessons learned:</label>
                <input type="text" id="lessonsLearned" name="lessonsLearned">
            </div>
        </div>
    </div>

    <!-- Right panel -->
    <div id="rightPanel">
        <div class="dropdown-container" id="impactOnInternal">
                <label for="impactOnInternal">Impact on internal</label>
        </div>

        <div class="dropdown-container" id="impactOnExternal">
                <label for="impactOnInternal">Impact on external</label>
        </div>

        <div class="dropdown-container" id="efforts">
                <label for="efforts">Efforts</label>
        </div>

        <div class="dropdown-container" id="costs">
                <label for="costs">Costs</label>
        </div>

        <div class="dropdown-container" id="availableDataInformation">
                <label for="availableDataInformation">Available data/information</label>
        </div>

        <div class="dropdown-container" id="dependencyLevel">
                <label for="dependencyLevel">Dependency level</label>
        </div>

        <div class="dropdown-container" id="changePropagation">
                <label for="changePropagation">Change propagation</label>
        </div>

        <div class="dropdown-container" id="changeReoccurrence">
                <label for="changeReoccurrence">Change reoccurrence</label>
        </div>

        <div class="dropdown-container" id="complexity">
                <label for="complexity">Complexity</label>
        </div>

        <div class="dropdown-container" id="challenges">
                <label for="challenges">Challenges</label>
        </div>

        <div class="dropdown-container" id="duration">
                <label for="duration">Duration</label>
        </div>

        <div class="dropdown-container" id="relevance">
                <label for="relevance">Relevance</label>
        </div>

        <div class="dropdown-container" id="urgency">
                <label for="urgency">Urgency</label>
        </div>

        <button id="save" onclick="saveData()">Save</button>
        <button id="deleteChange" onclick="deleteChange()">Delete</button>
        <button id="finish" onclick="window.location.href='{{ url_for('result') }}'">Finish</button>
    </div>

    <script>

    </script>

</body>
</html>